/*!
 * The Pentaho proprietary code is licensed under the terms and conditions of
 * the software license agreement entered into between the entity licensing such
 * code and Pentaho Corporation.
 */

/**
 * The Pentaho proprietary code is licensed under the terms and conditions of
 * the software license agreement entered into between the entity licensing such
 * code and Pentaho Corporation.
 *
 * Defines cv.util object which contains many handy utility functions.
 *
 */

dojo.require("dijit.Menu"),dojo.require("dijit.Dialog"),pen.define("analyzer/cv_base",[],function(){dojo.mixin(window.cv,{prefs:{suppressMsg:{},fadeTime:250,wipeTime:250,isDebug:0,skipDirtyAlert:!1},defaultNS:"http://www.pentaho.com",contextPath:"",dojoWidgets:{},helpTopics:{},helpWin:null,securityToken:null,nsResolver:function(e){return"http://www.pentaho.com"},getFieldHelp:null,getActiveReport:null,init:function(){var e=dojo.byId("stok");e&&(cv.securityToken=e.value);var t=!1;try{t=window.parent&&window.parent.PentahoMobile}catch(n){}!console_enabled&&!t&&(document.getElementsByTagName("body")[0].className+=" pentaho-page-background")}}),dojo.addOnLoad(cv,"init"),djConfig.bindEncoding="utf8",window.cvConst={}}),dojo.require("dojo.dnd.Manager"),dojo.require("dojox.xml.parser"),dojo.require("dojox.fx"),dojo.require("dojox.xml.parser"),dojo.require("dijit.PopupMenuItem"),dojo.require("dijit.MenuItem"),dojo.require("dijit.Tooltip"),dojo.require("dijit.layout.TabController"),dojo.require("dojo.parser"),dojo.require("dojo.cache"),dojo.require("dijit.layout._TabContainerBase"),dojo.require("dijit.layout.TabContainer"),dojo.require("dijit.DialogUnderlay"),pen.define("analyzer/cv_util",["analyzer/cv_base"],function(){cv.util={initDojoWidget:null,alertErrorOnPageOpen:function(e,t){alert(e),t&&(window.location=t)},delayThese:function(e,t,n,r){if(!e.length){typeof r=="function"&&r();return}typeof n=="undefined"&&typeof t=="number"?(n=t,t=function(){}):t||(t=function(){},n||(n=0)),setTimeout(function(){e.shift()(),t(),cv.util.delayThese(e,t,n,r)},n)},checkNumber:function(e){return e===""?!1:!isNaN(Number(e))},checkPositiveInteger:function(e){if(!cv.util.checkNumber(e))return!1;var t=parseInt(e);return t<=0||t!=parseFloat(e)?!1:!0},escapeHtml:function(e,t){return e=e.replace(/&/gm,"&amp;").replace(/</gm,"&lt;").replace(/>/gm,"&gt;").replace(/"/gm,"&quot;"),t||(e=e.replace(/'/gm,"&#39;")),e},escapeJavaScript:function(e){return e.replace(/(["'\f\b\n\t\r])/gm,"\\$1")},getAttribute:function(e,t){var n=e.getAttribute(t);return n&&(n=n.replace(/\xA0/g," ")),n},substituteParams:function(e,t){var n=typeof t=="object"?t:cv.util.toArray(arguments,1);return e.replace(/\%\{(\w+)\}/g,function(e,t){if(typeof n[t]!="undefined"&&n[t]!=null)return n[t];dojo.raise("Substitution not found: "+t)})},toArray:function(e,t){var n=[];for(var r=t||0;r<e.length;r++)n.push(e[r]);return n},summary:function(e,t){return!t||e.length<=t?e:e.substring(0,t).replace(/\.+$/,"")+"..."},connectPopupMenu:function(e,t){for(var n=0;t&&n<t.length;++n){var r=t[n],i=this.getDojoWidget(r.id);i&&(dojo.connect(i,"onClick",r.src?r.src:e,r.handler),dojo.connect(i,"onClick",function(){dijit.popup.close()}),r.disabled&&i.setDisabled(!0))}},showPopupMenu:function(e,t,n){t+=7,n+=7;var r=dojo.window.getBox().w,i=dojo.window.getBox().h;dijit.popup.open({popup:e,x:t,y:n}),n+e.domNode.offsetHeight>i&&(n=i-e.domNode.offsetHeight-30,dijit.popup.open({popup:e,x:t,y:n}));var s=dojo.connect(e,"onBlur",function(){dijit.popup.close(),dojo.disconnect(s)});e.focus()},destroyDojoWidgets:function(){for(var e in cv.dojoWidgets)try{cv.dojoWidgets[e]&&cv.dojoWidgets[e].destroy(!0)}catch(t){}},disconnectPopupMenu:function(e,t){for(var n=0;t&&n<t.length;++n){var r=this.getDojoWidget(t[n].id);r&&dojo.disconnect(r,"onClick",e,t[n].handler)}},displayWidget:function(e,t){if(this.getDojoWidget(e)){var n=this.getDojoWidget(e).domNode;n&&(t?dojo.style(n,"display",""):dojo.style(n,"display","none"))}},getAncestorByClass:function(e,t){while(e&&!dojo.hasClass(e,t))e=e.parentNode;return e},getFirstChildByClass:function(e,t){var n=dojo.query(" ."+t,e);if(n!==undefined&&n.length>0)return n[0]},getAncestorByTag:function(e,t){t=t.toLowerCase();while(e){if(e.tagName&&e.tagName.toLowerCase()==t)return e;e=e.parentNode}return null},getDojoWidget:function(id){if(cv.dojoWidgets[id])return cv.dojoWidgets[id];var wi=dijit.byId(id);if(!wi){wi=dojo.byId(id);if(!wi)return null;wi=dojo.parser.instantiate([wi]),wi&&wi.length>0?wi=wi[0]:wi=null}if(wi){this.initDojoWidget&&this.initDojoWidget(wi),cv.dojoWidgets[id]=wi;with(wi.domNode.style)zIndex=1002}return wi},stopDrag:function(){dojo.dnd.manager().stopDrag(),dojo.publish("/dnd/cancel")},helpdialog:null,getHelp:function(e){dojo.isObject(e)&&e.target&&(e=e.target.id),!e||e=="null"?e="":e.indexOf(".html")<0&&(e=cv.helpTopics&&cv.helpTopics[e]?cv.helpTopics[e]:""),e=cv.contextPath+"help/topic.html?"+e;if(window.location.search&&window.location.search.indexOf("embeddedHelp=true")>-1){this.helpDialog==null&&(this.helpDialog=new cv.HelpDialog,this.helpDialog.init()),this.helpDialog.showDlg(e);return}var t=dojo.window.getBox();cv.helpWin&&!cv.helpWin.closed&&cv.helpWin.close();var n=window.open(e,"helpWnd","height="+t.h*.8+",width="+t.w*.8+",menubar=0,status=0,toolbar=0,location=0,resizable=1");n&&(cv.helpWin=n),n.focus()},getSelectionList:function(e){var t=e.getElementsByTagName("INPUT"),n=[],r=t.length;for(var i=0;i<r;++i)t[i].checked&&n.push(t[i].name);return n.length==0&&(n=null),n},hide:function(){for(var e=0;e<arguments.length;++e)dojo.addClass(dojo.byId(arguments[e]),"hidden")},disableTextSelection:function(e){e.onselectstart=function(){return!1},dojo.style(e,{"-moz-user-select":"-moz-none","-khtml-user-select":"none","-webkit-user-select":"none","user-select":"none"})},initDivButton:function(e,t,n){dojo.isString(e)&&(e=dojo.byId(e));if(!e)return;dojo.connect(e,"onmouseover",this,"_divButtonActive"),dojo.connect(e,"onmousedown",this,"_divButtonPressed"),dojo.connect(e,"onmouseout",this,"_divButtonInactive"),dojo.connect(e,"onclick",this,"_divButtonInactive"),t?dojo.connect(e,"onclick",t,n):n&&dojo.connect(e,"onclick",n),cv.util.disableTextSelection(e)},isHidden:function(e){return dojo.hasClass(dojo.byId(e),"hidden")},gravity:function(node,e){node=dojo.byId(node);var mouse={y:e.clientY,x:e.clientX};with(dojo.html)var bb=dojo.coords(node),nodecenterx=bb.x+bb.w/2,nodecentery=bb.y+bb.h/2;with(cv.util.gravity)return(mouse.x<nodecenterx?WEST:EAST)|(mouse.y<nodecentery?NORTH:SOUTH)},overElement:function(e,t){if(!e)return!1;var n,r,i;switch(t.type){case"mouseout":case"mouseleave":if(t.target==e)return!1;break;default:if(t.target==e)return!0}if(e.tagName=="AREA"&&e.getAttribute("shape").toUpperCase()=="RECT"){var s=e.coords.split(","),o=dojo.query("img[usemap='#"+e.parentNode.getAttribute("name")+"']")[0];i=dojo.coords(o,!0),i.x+=parseInt(s[0]),i.y+=parseInt(s[1]),i.h+=parseInt(s[4])-parseInt(s[1]),i.w+=parseInt(s[3])-parseInt(s[0])}else i=dojo.coords(e,!0);var u=t.clientX,a=t.clientY;return u>i.x+i.w||u<i.x||a>i.y+i.h||a<i.y?!1:!0},setButtonDisabled:function(e,t){if(!e)return;if(t==e.disabled)return;if(e.tagName=="IMG"){var n=e.src.indexOf(".png")>-1?".png":".gif";e.src=t?e.src.replace(n,"_disabled"+n):e.src.replace("_disabled"+n,n)}else t?dojo.addClass(e,"disabled"):dojo.removeClass(e,"disabled");e.disabled=t},_divButtonActive:function(e){if(e.target.disabled)return;dojo.addClass(this.getAncestorByClass(e.target,"reportBtn"),"btnActive")},_divButtonInactive:function(e){var t=this.getAncestorByClass(e.target,"reportBtn");dojo.removeClass(t,"btnActive")},_divButtonPressed:function(e){if(e.target.disabled)return},onToggleSectionCheckbox:function(e){e.target.checked?dojox.fx.wipeIn({duration:cv.prefs.wipeTime,node:e.target.id+"DIV"}).play():dojox.fx.wipeOut({duration:cv.prefs.wipeTime,node:e.target.id+"DIV"}).play()},parseMDXExpression:function(e,t){var n=e.lastIndexOf("].[");if(n==-1)return"";e=e.substring(n);var r=/\]\.\[(.+)\]$/,i=r.exec(e);if(!i)return"";var s=i[1];return s=s.replace("]]","]"),s=="#null"?cvCatalog.attributeNullValue:s.search(/\S/)<0?cvCatalog.attributeBlankValue:t?cv.util.escapeHtml(s):s},parseAjaxMsg:function(e){if(dojo.isString(e)){if(e.indexOf('<form name="login"')>0){var t={loginCallback:function(){cv.getActiveReport()&&cv.getActiveReport().refreshReport()}};if(console_enabled&&window.parent.authenticate)return window.parent.authenticate(t),"sessionExpired";cv.getActiveReport()&&(cv.getActiveReport().setReportPropsDirty(!1),cv.getActiveReport().history.setSaved()),window.location.reload()}var n=e.indexOf("<message");if(n<0)return;var r=e.indexOf("</message>");if(r<0){r=e.indexOf("/>",n);if(r<0)return;r+=2}else r+=10;e=dojox.xml.parser.parse(e.substring(n,r)),cv.setDomDefaultNamespace(e)}if(dojo.isObject(e)&&e.documentElement&&e.documentElement.tagName=="message"){var i=e.documentElement.getAttribute("id"),s=e.documentElement.attributes,o={};for(var u=0;u<s.length;++u){var a=s.item(u);a.name&&(o[a.name]=a.value)}var f=e.documentElement.selectSingleNode("cv:selectionItems");return f!=null&&cv.getActiveReport().reportDoc.replaceSelectionItems(f.cloneNode(!0)),o}return null},parseURLQuery:function(e){e||(e=window.location.search);if(e.length==0)return null;var t=e.substring(1).split("&"),n={};for(var r=0;r<t.length;++r){var i=t[r].indexOf("=");i>0&&(n[t[r].substring(0,i)]=decodeURIComponent(t[r].substring(i+1)))}return n},getURLQueryValue:function(e,t){var n=this.parseURLQuery(t);return n?n[e]:null},removeNode:function(e){e&&e.parentNode.removeChild(e)},setCommonMsgTooltip:function(e){if(!e)return;var t=this.getDojoWidget("commonMsgTooltip");t&&(t.domNode.innerHTML=e)},setDivActive:function(e,t){t?dojo.addClass(e,"active"):dojo.removeClass(e,"active")},setHelpTopics:function(e){for(var t=0;t<e.length;++t){var n=typeof e[t]=="string"?dojo.byId(e[t]):e[t];dojo.connect(n,"onclick",this,"getHelp"),cv.helpTopics[e[t]]=e[++t]}},setMenuItem:function(e,t,n){dojo.isString(e)&&(e=this.getDojoWidget(e));if(!e)return;if(t){var r=e.iconNode;t&&t=="checked"?r.src=cv.contextPath+"images/checkmark.png":r.src=dojo.moduleUrl("dojo","resources/blank.gif").toString()}n&&e.setDisabled(n=="disabled"?!0:!1)},setSectionCollapsed:function(e){var t=!0,n=dojo.byId(e);n&&(n.type=="checkbox"?n.checked=!1:n.tagName=="IMG"&&(this.hide(n.id+"DIV"),n.name="closed",n.src=n.src.replace(/opened\./,"closed."),t=!1)),t&&dojox.fx.wipeOut({duration:0,node:dojo.byId(e+"DIV")}).play()},show:function(){for(var e=0;e<arguments.length;++e){if(arguments[e].tagName){dojo.removeClass(arguments[e],"hidden");continue}dojo.removeClass(dojo.byId(arguments[e]),"hidden")}},updateMenuItemCaption:function(e,t,n){var r=this.getDojoWidget(e);if(!r)return;t=cvCatalog[t],n&&(t=cv.util.substituteParams(t,n)),r.setLabel(t)},TRACE:function(e){if(cv.prefs.isDebug<2)return;try{if(e=="_INIT")this.TRACEWIN=window.open("","cvtrace","resizable=1,scrollbars=1"),this.TRACEWIN.document.open(),this.TRACEWIN.document.writeln("<b>INITIALIZE ClearView JS Trace</b><p>");else if(e=="_EXIT")this.TRACEWIN.document.writeln("<b>EXIT ClearView JS Trace</b>"),this.TRACEWIN.document.close(),this.TRACEWIN.close();else if(e=="_START")this.TSBASE=this.TSSTART=new Date,this.TRACEWIN.document.writeln("<b>Start Profiling at: "+this.TSSTART+"</b><br>");else if(e=="_END")this.TRACEWIN.document.writeln("<b>Finish Profiling - Total: "+(new Date-this.TSSTART)+" ms</b><p>");else if(e=="_CLEAR")this.TRACEWIN.document.clear();else{var t=new Date;this.TRACEWIN.document.writeln("&nbsp;&nbsp;&nbsp;&nbsp;"+e+": "+(t-this.TSBASE)+" ms<br>"),this.TSBASE=new Date}}catch(n){}},createEvent:function(e){var t=new Object;return t.target=e,t.clientX=0,t.clientY=0,t.stopPropagation=function(){},t.preventDefault=function(){},t},convertStringtoDate:function(e){var t=e;return t=t.replace(/-/g,"/"),t=t.replace("T"," "),t=t.replace("Z"," GMT-0000"),new Date(Date.parse(t))},formatDateString:function(e){var t=this.convertStringtoDate(e),n=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],r=n[t.getMonth()],i=t.getDate(),s=t.getFullYear(),o=t.toLocaleTimeString();return o.indexOf("0")==0&&(o=o.substring(1)),r+" "+i+", "+s+" "+o},goToURL:function(e){try{window.location=e}catch(t){if(!(dojo.isIE&&t.message.indexOf("Unspecified error")>-1))throw t}},selectByValue:function(e,t){for(var n=0;n<e.length;n++)e.options[n].value==t?e.options[n].selected=!0:e.options[n].selected=!1},addChartMenuItems:function(e){var t=[],n=cv.pentahoVisualizations.slice();n.sort(function(e,t){var n=e.menuOrdinal?e.menuOrdinal:1e4,r=t.menuOrdinal?t.menuOrdinal:1e4;return n-r});for(var r=0;r<n.length;r++){n[r].menuSeparator&&e.addChild(new dijit.MenuSeparator({id:"menu-item100000"+r}));var i=new dijit.MenuItem({id:n[r].id,customType:!0,label:n[r].name});e.addChild(i),t.push(i)}if(cv.analyzerProperties["chart.retain.jfreechart"]){var s=new dijit.Menu;dojo.addClass(s.domNode,"pentaho-menu-outer pentaho-menu");var o=new dijit.PopupMenuItem({label:cvCatalog.VIZ_LEGACY,popup:s});e.addChild(new dijit.MenuSeparator),e.addChild(o);var i=new dijit.MenuItem({id:"VERTICAL_BAR",label:cvCatalog.VIZ_VERTICAL_BAR});s.addChild(i),t.push(i),i=new dijit.MenuItem({id:"STACKED_VERTICAL_BAR",label:cvCatalog.VIZ_STACKED_VERTICAL_BAR}),s.addChild(i),t.push(i),i=new dijit.MenuItem({id:"PCT_STACKED_VERTICAL_BAR",label:cvCatalog.VIZ_PCT_STACKED_VERTICAL_BAR}),s.addChild(i),t.push(i),s.addChild(new dijit.MenuSeparator({id:"menu-item520"})),i=new dijit.MenuItem({id:"HORIZONTAL_BAR",label:cvCatalog.VIZ_HORIZONTAL_BAR}),s.addChild(i),t.push(i),i=new dijit.MenuItem({id:"STACKED_HORIZONTAL_BAR",label:cvCatalog.VIZ_STACKED_HORIZONTAL_BAR}),s.addChild(i),t.push(i),i=new dijit.MenuItem({id:"PCT_STACKED_HORIZONTAL_BAR",label:cvCatalog.VIZ_PCT_STACKED_HORIZONTAL_BAR}),s.addChild(i),t.push(i),s.addChild(new dijit.MenuSeparator({id:"menu-item523"})),i=new dijit.MenuItem({id:"LINE",label:cvCatalog.VIZ_LINE}),s.addChild(i),t.push(i),i=new dijit.MenuItem({id:"MULTIPLE_PIE",label:cvCatalog.VIZ_MULTIPLE_PIE}),s.addChild(i),t.push(i),i=new dijit.MenuItem({id:"STACKED_AREA",label:cvCatalog.VIZ_STACKED_AREA}),s.addChild(i),t.push(i),i=new dijit.MenuItem({id:"SCATTER",label:cvCatalog.VIZ_SCATTER}),s.addChild(i),t.push(i)}return t}},cv.util.gravity.NORTH=1,cv.util.gravity.SOUTH=2,cv.util.gravity.EAST=4,cv.util.gravity.WEST=8,dojo.declare("cv.Collapsible",null,{constructor:function(e,t,n,r,i){this.header=e,this.body=t,this.cssOpen=r?r:"folderClose",this.cssClose=i?i:"folderOpen",this.isOpen=n==1,this.setState(this.isOpen,!0),cv.util.disableTextSelection(e),dojo.connect(e,"onclick",this,"onClickHeader")},onClickHeader:function(e){if(!this.animation||this.animation.status()!="playing")this.isOpen=!this.isOpen,this.setState(this.isOpen,!0);e.stopPropagation()},setState:function(e,t){e?(dojo.removeClass(this.header,this.cssOpen),dojo.addClass(this.header,this.cssClose),t?(this.body.style.display="block",this.animation=null):this.animation=dojox.fx.wipeIn({duration:cv.prefs.wipeTime,node:this.body}).play()):(dojo.removeClass(this.header,this.cssClose),dojo.addClass(this.header,this.cssOpen),t?(this.body.style.display="none",this.animation=null):this.animation=dojox.fx.wipeOut({duration:cv.prefs.wipeTime,node:this.body}).play())}}),dojo.declare("cv.dnd.Avatar",[dojo.dnd.Avatar],{constructor:function(e,t){this.manager=e,this.node=t},update:function(){}}),dojo.declare("cv.dnd.Manager",[dojo.dnd.Manager],{opacity:.8,startDrag:function(e,t,n){if(!t||t.length==0)return;if(cv.getActiveReport().isResizing)return;this.inherited(arguments)},makeAvatar:function(){var formula=this.nodes[0].getAttribute("formula"),node;if(formula){node=document.createElement("DIV");var dragClass;if(dojo.hasClass(this.nodes[0],"filterItem")||dojo.hasClass(this.nodes[0],"filterGroup")){dragClass="filterDragObject";if(this.nodes[0].id.indexOf("filter_metric")==0)node.innerHTML=cvCatalog.filterMetric;else{var spans=this.nodes[0].getElementsByTagName("span");node.innerHTML=cv.textContent(spans[0])}node.setAttribute("formula",this.nodes[0].id)}else{var type=this.nodes[0].getAttribute("metrictype")?"V":cv.getFieldHelp().getDndType(formula);dragClass=type=="V"?"metricDragObject":"attributeDragObject",node.innerHTML=cv.util.escapeHtml(cv.textContent(this.nodes[0])),node.setAttribute("formula",formula)}dojo.addClass(node,"commonDragObject"),dragClass&&dojo.addClass(node,dragClass),this.opacity<1&&dojo.style(node,"opacity",this.opacity)}else if(this.type=="DB"){node=document.createElement("DIV");var box=dojo.position(this.nodes[0]);with(node.style)border="2px dashed black",height=box.h+"px",width=box.w+"px",backgroundColor="silver";this.opacity<1&&dojo.style(node,"opacity",this.opacity)}else{node=this.nodes[0].cloneNode(!0),this.dragClass&&dojo.addClass(node,this.dragClass),this.opacity<1&&dojo.style(node,"opacity",this.opacity);var ltn=node.tagName.toLowerCase(),isTr=ltn=="tr";if(isTr||ltn=="tbody"){var doc=this.nodes[0].ownerDocument,table=doc.createElement("table");if(isTr){var tbody=doc.createElement("tbody");table.appendChild(tbody),tbody.appendChild(node)}else table.appendChild(node);var tmpSrcTr=isTr?this.nodes[0]:this.nodes[0].firstChild,tmpDstTr=isTr?node:node.firstChild,domTds=tdp.childNodes,cloneTds=tmpDstTr.childNodes;for(var i=0;i<domTds.length;i++)cloneTds[i]&&cloneTds[i].style&&(cloneTds[i].style.width=dojo.contentBox(domTds[i]).w+"px");node=table}}if(dojo.isIE<7&&this.createIframe){with(node.style)top="0px",left="0px";var outer=document.createElement("div");outer.appendChild(node),this.bgIframe=new dojo.html.BackgroundIframe(outer),outer.appendChild(this.bgIframe.iframe),node=outer}return node.style.zIndex=999,node.style.position="absolute",new cv.dnd.Avatar(dojo.dnd.manager(),node)}}),dojo.dnd._manager=new cv.dnd.Manager,dojo.extend(dijit.MenuItem,{onClick:function(){dijit.popup.close()}})}),pen.define("analyzer/analyzer-selectSchema",["analyzer/cv_base","analyzer/cv_util"])